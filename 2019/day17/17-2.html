<html>
    <body>
        program:
        <textarea id="program">1,330,331,332,109,3448,1101,0,1182,16,1101,0,1439,24,101,0,0,570,1006,570,36,102,1,571,0,1001,570,-1,570,1001,24,1,24,1105,1,18,1008,571,0,571,1001,16,1,16,1008,16,1439,570,1006,570,14,21102,58,1,0,1105,1,786,1006,332,62,99,21102,1,333,1,21101,73,0,0,1106,0,579,1102,1,0,572,1102,1,0,573,3,574,101,1,573,573,1007,574,65,570,1005,570,151,107,67,574,570,1005,570,151,1001,574,-64,574,1002,574,-1,574,1001,572,1,572,1007,572,11,570,1006,570,165,101,1182,572,127,1002,574,1,0,3,574,101,1,573,573,1008,574,10,570,1005,570,189,1008,574,44,570,1006,570,158,1105,1,81,21102,340,1,1,1105,1,177,21101,0,477,1,1105,1,177,21102,514,1,1,21102,176,1,0,1105,1,579,99,21101,184,0,0,1106,0,579,4,574,104,10,99,1007,573,22,570,1006,570,165,101,0,572,1182,21101,0,375,1,21101,0,211,0,1105,1,579,21101,1182,11,1,21102,1,222,0,1106,0,979,21102,1,388,1,21101,233,0,0,1106,0,579,21101,1182,22,1,21101,244,0,0,1105,1,979,21102,401,1,1,21102,255,1,0,1106,0,579,21101,1182,33,1,21101,266,0,0,1105,1,979,21102,1,414,1,21101,277,0,0,1105,1,579,3,575,1008,575,89,570,1008,575,121,575,1,575,570,575,3,574,1008,574,10,570,1006,570,291,104,10,21101,0,1182,1,21102,1,313,0,1105,1,622,1005,575,327,1101,0,1,575,21102,327,1,0,1106,0,786,4,438,99,0,1,1,6,77,97,105,110,58,10,33,10,69,120,112,101,99,116,101,100,32,102,117,110,99,116,105,111,110,32,110,97,109,101,32,98,117,116,32,103,111,116,58,32,0,12,70,117,110,99,116,105,111,110,32,65,58,10,12,70,117,110,99,116,105,111,110,32,66,58,10,12,70,117,110,99,116,105,111,110,32,67,58,10,23,67,111,110,116,105,110,117,111,117,115,32,118,105,100,101,111,32,102,101,101,100,63,10,0,37,10,69,120,112,101,99,116,101,100,32,82,44,32,76,44,32,111,114,32,100,105,115,116,97,110,99,101,32,98,117,116,32,103,111,116,58,32,36,10,69,120,112,101,99,116,101,100,32,99,111,109,109,97,32,111,114,32,110,101,119,108,105,110,101,32,98,117,116,32,103,111,116,58,32,43,10,68,101,102,105,110,105,116,105,111,110,115,32,109,97,121,32,98,101,32,97,116,32,109,111,115,116,32,50,48,32,99,104,97,114,97,99,116,101,114,115,33,10,94,62,118,60,0,1,0,-1,-1,0,1,0,0,0,0,0,0,1,40,18,0,109,4,2101,0,-3,587,20101,0,0,-1,22101,1,-3,-3,21101,0,0,-2,2208,-2,-1,570,1005,570,617,2201,-3,-2,609,4,0,21201,-2,1,-2,1105,1,597,109,-4,2105,1,0,109,5,1201,-4,0,629,21002,0,1,-2,22101,1,-4,-4,21101,0,0,-3,2208,-3,-2,570,1005,570,781,2201,-4,-3,653,20101,0,0,-1,1208,-1,-4,570,1005,570,709,1208,-1,-5,570,1005,570,734,1207,-1,0,570,1005,570,759,1206,-1,774,1001,578,562,684,1,0,576,576,1001,578,566,692,1,0,577,577,21102,1,702,0,1106,0,786,21201,-1,-1,-1,1105,1,676,1001,578,1,578,1008,578,4,570,1006,570,724,1001,578,-4,578,21102,1,731,0,1106,0,786,1105,1,774,1001,578,-1,578,1008,578,-1,570,1006,570,749,1001,578,4,578,21101,0,756,0,1105,1,786,1106,0,774,21202,-1,-11,1,22101,1182,1,1,21101,0,774,0,1106,0,622,21201,-3,1,-3,1105,1,640,109,-5,2105,1,0,109,7,1005,575,802,20101,0,576,-6,20101,0,577,-5,1106,0,814,21101,0,0,-1,21101,0,0,-5,21101,0,0,-6,20208,-6,576,-2,208,-5,577,570,22002,570,-2,-2,21202,-5,41,-3,22201,-6,-3,-3,22101,1439,-3,-3,1201,-3,0,843,1005,0,863,21202,-2,42,-4,22101,46,-4,-4,1206,-2,924,21101,1,0,-1,1106,0,924,1205,-2,873,21102,1,35,-4,1106,0,924,2102,1,-3,878,1008,0,1,570,1006,570,916,1001,374,1,374,1202,-3,1,895,1102,1,2,0,2101,0,-3,902,1001,438,0,438,2202,-6,-5,570,1,570,374,570,1,570,438,438,1001,578,558,922,20102,1,0,-4,1006,575,959,204,-4,22101,1,-6,-6,1208,-6,41,570,1006,570,814,104,10,22101,1,-5,-5,1208,-5,49,570,1006,570,810,104,10,1206,-1,974,99,1206,-1,974,1102,1,1,575,21101,973,0,0,1105,1,786,99,109,-7,2106,0,0,109,6,21102,0,1,-4,21102,0,1,-3,203,-2,22101,1,-3,-3,21208,-2,82,-1,1205,-1,1030,21208,-2,76,-1,1205,-1,1037,21207,-2,48,-1,1205,-1,1124,22107,57,-2,-1,1205,-1,1124,21201,-2,-48,-2,1106,0,1041,21101,0,-4,-2,1105,1,1041,21101,-5,0,-2,21201,-4,1,-4,21207,-4,11,-1,1206,-1,1138,2201,-5,-4,1059,2101,0,-2,0,203,-2,22101,1,-3,-3,21207,-2,48,-1,1205,-1,1107,22107,57,-2,-1,1205,-1,1107,21201,-2,-48,-2,2201,-5,-4,1090,20102,10,0,-1,22201,-2,-1,-2,2201,-5,-4,1103,2101,0,-2,0,1105,1,1060,21208,-2,10,-1,1205,-1,1162,21208,-2,44,-1,1206,-1,1131,1106,0,989,21101,439,0,1,1106,0,1150,21101,0,477,1,1106,0,1150,21101,0,514,1,21101,1149,0,0,1105,1,579,99,21102,1157,1,0,1106,0,579,204,-2,104,10,99,21207,-3,22,-1,1206,-1,1138,2102,1,-5,1176,1201,-4,0,0,109,-6,2106,0,0,0,7,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,23,5,6,1,5,1,23,1,3,1,6,1,5,1,23,1,3,1,6,1,5,1,23,1,3,1,6,11,17,11,8,1,3,1,17,1,1,1,3,1,3,1,8,7,11,7,3,1,3,1,12,1,1,1,11,1,3,1,5,1,3,1,12,1,1,1,11,1,3,1,5,1,3,1,12,1,1,1,11,1,3,1,5,1,3,1,12,7,7,1,1,13,14,1,3,1,7,1,1,1,1,1,5,1,18,13,1,1,1,1,5,7,16,1,9,1,1,1,28,1,5,7,28,1,5,1,3,1,30,1,3,7,30,1,3,1,1,1,34,1,3,1,1,1,34,1,3,1,1,1,28,13,28,1,5,1,3,1,30,1,5,5,30,1,40,7,40,1,40,1,1,1,38,1,1,1,38,1,1,1,38,1,1,1,38,7,36,1,3,1,36,11,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,1,5,1,34,7,12</textarea>
        <button onclick="myFunction()">DoIt!</button>
        result:
        <input id="res" readonly/>

        <script>
            var program;
            var relativeBase;
            var str;
            var field;
            var position;
            var forward;
            var end;
            var steps;
            var inputCoded;
            var indexInput;
            var res;
            function myFunction() {
                str = '';
                field = new Array(new Array());
                forward = 0;
                end = false;
                position = new Object();
                steps = new Array();

                program = document.getElementById('program').value.split(',');
                //faccio girare il porgramma per avere il traccaito delle rotaie
                runIntcode();
                //console.log(str);
                //traccio il percorso
                while (!end) {
                    nextPosition();
                }

                console.log(steps.join());
                //trovo come dividere le istruzioni in bloccchi
                var stepsStr = steps.join();
                var patterns = new Array();
                var code = 65;
                for (var i = 0; i < steps.length; i++) {
                    for (var size = 2; size < 20; size++) {
                        if (i + size <= steps.length) {
                            var tmp = steps.slice(i, size).join();
                            if (tmp !== "" && tmp.length >= 3 && patterns.indexOf(tmp) === -1) {
                                var re = new RegExp(tmp, "g");
                                if (stepsStr.match(re).length > 3) {
                                    console.log(tmp + ' - ' + stepsStr.match(re).length);
                                    patterns.push(tmp);
                                    code++;
                                }
                            }
                        }
                    }
                }
                
                /*
                var input = "A,B,C,A,D,A,B,D,A,B,A,E,E,F,A,G,C,H,D,H,B,H,E,E,D,A,B,C,A,F,A,G,A,I,E,D\nL,6\nR,12\nL,4\nR,6\nL,10\nR,5\nR,11\nL,5\nL,9\nn\n".split('');
                inputCoded = new Array();
                indexInput = 0;
                input.forEach(function(element){
                    inputCoded.push(element.charCodeAt(0));
                });
                
                //facci girare nuovamente il programma, ma stavolta muovendo il robot con le istruzioni che ho creato
                program = document.getElementById('program').value.split(',');
                program[0] = 2;
                res = 0;
                runIntcode();
                console.log(res);
                console.log('end');
                //document.getElementById('res').value = alignment;
                 */
            }

            function runIntcode() {
                relativeBase = 0;
                for (var i = 0; i < Object.keys(program).length; ) {

                    var tmp = program[i].toString();
                    var operation = tmp.length > 2 ? (parseInt(tmp.substr(tmp.length - 2, 2))) : parseInt(tmp);
                    var mode1 = tmp.length > 2 ? (parseInt(tmp.substr(tmp.length - 3, 1))) : 0;
                    var mode2 = tmp.length > 3 ? (parseInt(tmp.substr(tmp.length - 4, 1))) : 0;
                    var mode3 = tmp.length === 5 ? (parseInt(tmp.substr(tmp.length - 5, 1))) : 0;
                    i = stuff(operation, mode1, mode2, mode3, i);

                }
            }

            function stuff(operation, mode1, mode2, mode3, i) {
                if (operation === 1) {
                    var pos1 = getPosition(mode1, 1, i);
                    var pos2 = getPosition(mode2, 2, i);
                    var pos3 = getPosition(mode3, 3, i);
                    program[pos3] = parseInt(program[pos1]) + parseInt(program[pos2]);
                    i = i + 4;
                } else if (operation === 2) {
                    var pos1 = getPosition(mode1, 1, i);
                    var pos2 = getPosition(mode2, 2, i);
                    var pos3 = getPosition(mode3, 3, i);
                    program[pos3] = parseInt(program[pos1]) * parseInt(program[pos2]);
                    i = i + 4;
                } else if (operation === 3) {
                    var pos1 = getPosition(mode1, 1, i);
                    program[pos1] = inputCoded[indexInput];
                    indexInput++;
                    i = i + 2;
                } else if (operation === 4) {
                    var pos1 = getPosition(mode1, 1, i);
                    res = res + parseInt(program[pos1]);
                    var tmp = String.fromCharCode(parseInt(program[pos1]));
                    str = str + tmp;
                    if (parseInt(program[pos1]) === 10) {
                        field.push(new Array());
                    } else {
                        if (tmp === '^' || tmp === 'v' || tmp === '<' || tmp === '>') {
                            position.y = field.length - 1;
                            position.x = field[field.length - 1].length;
                            position.direction = tmp;
                        }
                        field[field.length - 1].push(tmp);
                    }
                    i = i + 2;
                } else if (operation === 5) {
                    var pos1 = getPosition(mode1, 1, i);
                    var pos2 = getPosition(mode2, 2, i);
                    if (parseInt(program[pos1]) > 0) {
                        i = parseInt(program[pos2]);
                    } else {
                        i = i + 3;
                    }
                } else if (operation === 6) {
                    var pos1 = getPosition(mode1, 1, i);
                    var pos2 = getPosition(mode2, 2, i);
                    if (parseInt(program[pos1]) === 0) {
                        i = parseInt(program[pos2]);
                    } else {
                        i = i + 3;
                    }
                } else if (operation === 7) {
                    var pos1 = getPosition(mode1, 1, i);
                    var pos2 = getPosition(mode2, 2, i);
                    var pos3 = getPosition(mode3, 3, i);
                    if (parseInt(program[pos1]) < parseInt(program[pos2])) {
                        program[pos3] = 1;
                    } else {
                        program[pos3] = 0;
                    }
                    i = i + 4;
                } else if (operation === 8) {
                    var pos1 = getPosition(mode1, 1, i);
                    var pos2 = getPosition(mode2, 2, i);
                    var pos3 = getPosition(mode3, 3, i);
                    if (parseInt(program[pos1]) === parseInt(program[pos2])) {
                        program[pos3] = 1;
                    } else {
                        program[pos3] = 0;
                    }
                    i = i + 4;
                } else if (operation === 9) {
                    var pos1 = getPosition(mode1, 1, i);
                    relativeBase = relativeBase + parseInt(program[pos1]);
                    i = i + 2;
                } else if (operation === 99) {
                    i = program.length;
                }

                return(i);
            }

            function getPosition(mode, nParameter, i) {
                var parameter = 0;
                switch (mode) {
                    case 0:
                        parameter = parseInt(program[i + nParameter]);
                        break;
                    case 1:
                        parameter = i + nParameter;
                        break;
                    case 2:
                        parameter = relativeBase + parseInt(program[i + nParameter]);
                        break;
                }
                return(parameter);
            }

            function nextPosition() {
                switch (position.direction) {
                    case '^':
                        if (position.y - 1 > -1) {
                            if (field[position.y - 1][position.x] === '#') {
                                position.y--;
                                forward++;
                            } else {
                                newDirection();
                            }
                        } else {
                            newDirection();
                        }
                        break;
                    case 'v':
                        if (position.y + 1 < field.length) {
                            if (field[position.y + 1][position.x] === '#') {
                                position.y++;
                                forward++;
                            } else {
                                newDirection();
                            }
                        } else {
                            newDirection();
                        }
                        break;
                    case '<':
                        if (position.x - 1 > -1) {
                            if (field[position.y][position.x - 1] === '#') {
                                position.x--;
                                forward++;
                            } else {
                                newDirection();
                            }
                        } else {
                            newDirection();
                        }
                        break;
                    case '>':
                        if (position.x + 1 < field[position.y].length) {
                            if (field[position.y][position.x + 1] === '#') {
                                position.x++;
                                forward++;
                            } else {
                                newDirection();
                            }
                        } else {
                            newDirection();
                        }
                        break;
                }
            }

            function newDirection() {
                if (forward > 0) {
                    steps.push(forward);
                    forward = 0;
                }
                switch (position.direction) {
                    case '^':
                        if (field[position.y][position.x + 1] === '#') {
                            position.direction = '>';
                            steps.push('R');
                        } else if (field[position.y][position.x - 1] === '#') {
                            position.direction = '<';
                            steps.push('L');
                        } else {
                            end = true;
                        }
                        break;
                    case 'v':
                        if (field[position.y][position.x + 1] === '#') {
                            position.direction = '>';
                            steps.push('L');
                        } else if (field[position.y][position.x - 1] === '#') {
                            position.direction = '<';
                            steps.push('R');
                        } else {
                            end = true;
                        }
                        break;
                    case '<':
                        if (field[position.y + 1][position.x] === '#') {
                            position.direction = 'v';
                            steps.push('L');
                        } else if (field[position.y - 1][position.x] === '#') {
                            position.direction = '^';
                            steps.push('R');
                        } else {
                            end = true;
                        }
                        break;
                    case '>':
                        if (field[position.y + 1][position.x] === '#') {
                            position.y++;
                            position.direction = 'v';
                            steps.push('R');
                        } else if (field[position.y - 1][position.x] === '#') {
                            position.y--;
                            position.direction = '^';
                            steps.push('L');
                        } else {
                            end = true;
                        }
                        break;
                }
            }
        </script>
    </body>
</html>